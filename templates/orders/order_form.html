{% extends 'base.html' %}

{% block title %}{{ title }} - CRMStore{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center mb-4">
    <div class="d-flex align-items-center gap-3">
        <a href="{% url 'order_list' %}" class="btn btn-outline btn-icon">
            <i class="bi bi-arrow-left"></i>
        </a>
        <div>
            <h1 class="page-title">{{ title }}</h1>
            <p class="page-subtitle mb-0">Заповніть всі поля форми</p>
        </div>
    </div>
</div>

<form method="POST" id="orderForm">
    {% csrf_token %}

    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="bi bi-person me-2"></i>
                        Клієнт
                    </h3>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Оберіть існуючого клієнта</label>
                        {{ form.customer }}
                    </div>

                    <div class="text-center text-muted my-3">— або створіть нового —</div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">ПІБ нового клієнта</label>
                            {{ form.new_customer_name }}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Телефон</label>
                            {{ form.new_customer_phone }}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Джерело</label>
                            {{ form.new_customer_source }}
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="bi bi-box me-2"></i>
                        Товари
                    </h3>
                    <button type="button" class="btn btn-sm btn-primary" id="addItem">
                        <i class="bi bi-plus-lg"></i>
                        Додати товар
                    </button>
                </div>
                <div class="card-body p-0">
                    {{ formset.management_form }}

                    <table class="data-table" id="itemsTable">
                        <thead>
                            <tr>
                                <th style="width: 40%">Товар</th>
                                <th style="width: 15%">Кількість</th>
                                <th style="width: 20%">Ціна</th>
                                <th style="width: 20%">Сума</th>
                                <th style="width: 5%"></th>
                            </tr>
                        </thead>
                        <tbody id="itemsBody">
                            {% for item_form in formset %}
                            <tr class="item-row">
                                <td>
                                    {{ item_form.id }}
                                    {{ item_form.product }}
                                </td>
                                <td>
                                    {{ item_form.quantity }}
                                </td>
                                <td>
                                    {{ item_form.price }}
                                </td>
                                <td class="item-total">
                                    <strong>0 ₴</strong>
                                </td>
                                <td>
                                    {{ item_form.DELETE }}
                                    <button type="button" class="action-btn delete remove-item" title="Видалити">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" class="text-end"><strong>Всього:</strong></td>
                                <td><strong id="grandTotal">0 ₴</strong></td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="bi bi-sticky me-2"></i>
                        Примітки
                    </h3>
                </div>
                <div class="card-body">
                    {{ form.notes }}
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="bi bi-truck me-2"></i>
                        Доставка
                    </h3>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Служба доставки</label>
                        {{ form.delivery_service }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Місто *</label>
                        {{ form.city }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Відділення</label>
                        {{ form.warehouse }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ТТН</label>
                        {{ form.ttn }}
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="bi bi-credit-card me-2"></i>
                        Оплата
                    </h3>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Тип оплати</label>
                        {{ form.payment_type }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Передплата (₴)</label>
                        {{ form.prepayment }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Витрати продавця (₴)</label>
                        {{ form.seller_expenses }}
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="bi bi-flag me-2"></i>
                        Статус
                    </h3>
                </div>
                <div class="card-body">
                    {{ form.status }}
                </div>
            </div>

            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="bi bi-check-lg me-2"></i>
                    Зберегти замовлення
                </button>
                <a href="{% url 'order_list' %}" class="btn btn-secondary">
                    Скасувати
                </a>
            </div>
        </div>
    </div>
</form>

<template id="itemRowTemplate">
    <tr class="item-row">
        <td>
            <select name="items-__prefix__-product" class="form-select product-select">
                <option value="">-- Оберіть товар --</option>
                {% for product in products %}
                <option value="{{ product.pk }}" data-price="{{ product.selling_price }}">{{ product.name }} ({{
                    product.stock }} шт)</option>
                {% endfor %}
            </select>
        </td>
        <td>
            <input type="number" name="items-__prefix__-quantity" class="form-control quantity-input" min="1" value="1">
        </td>
        <td>
            <input type="number" name="items-__prefix__-price" class="form-control price-input" step="0.01" min="0">
        </td>
        <td class="item-total">
            <strong>0 ₴</strong>
        </td>
        <td>
            <button type="button" class="action-btn delete remove-item" title="Видалити">
                <i class="bi bi-trash"></i>
            </button>
        </td>
    </tr>
</template>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log("Order form script loaded");
        const itemsBody = document.getElementById('itemsBody');
        const addButton = document.getElementById('addItem');
        const template = document.getElementById('itemRowTemplate');
        const totalFormsInput = document.querySelector('[name="items-TOTAL_FORMS"]') || document.querySelector('[name="form-TOTAL_FORMS"]');

        if (!totalFormsInput) {
            console.error("TOTAL_FORMS input not found! Check formset prefix.");
            return; // Stop execution if critical element is missing
        }
        console.log("Total forms input found:", totalFormsInput.name);

        const productPrices = {
        {% for product in products %}
        "{{ product.pk }}": {{ product.selling_price|stringformat:"f" }}{% if not forloop.last %}, {% endif %}
        {% endfor %}
    };
    console.log("Product prices loaded:", Object.keys(productPrices).length);

    addButton.addEventListener('click', function () {
        console.log("Add button clicked");
        const formCount = parseInt(totalFormsInput.value);
        console.log("Current form count:", formCount);

        const newRow = template.content.cloneNode(true);
        const tr = newRow.querySelector('tr');
        if (!tr) {
            console.error("Could not find TR in template");
            return;
        }

        tr.innerHTML = tr.innerHTML.replace(/__prefix__/g, formCount);
        itemsBody.appendChild(tr);
        totalFormsInput.value = formCount + 1;
        bindRowEvents(tr);
    });

    function removeRow(btn) {
        console.log("Remove row clicked");
        const row = btn.closest('tr');
        const deleteCheckbox = row.querySelector('[name*="-DELETE"]');
        if (deleteCheckbox) {
            console.log("Marking for deletion");
            deleteCheckbox.checked = true;
            row.style.display = 'none';
        } else {
            console.log("Removing new row");
            row.remove();
        }
        calculateTotal();
    }

    function calculateRowTotal(row) {
        const quantity = parseFloat(row.querySelector('.quantity-input')?.value) || 0;
        const price = parseFloat(row.querySelector('.price-input')?.value) || 0;
        const total = quantity * price;
        const totalEl = row.querySelector('.item-total strong');
        if (totalEl) totalEl.textContent = total.toFixed(0) + ' ₴';
        return total;
    }

    function calculateTotal() {
        let grandTotal = 0;
        document.querySelectorAll('.item-row').forEach(row => {
            if (row.style.display !== 'none') {
                grandTotal += calculateRowTotal(row);
            }
        });
        document.getElementById('grandTotal').textContent = grandTotal.toFixed(0) + ' ₴';
    }

    function onProductChange(select) {
        console.log("Product changed", select.value);
        const row = select.closest('tr');
        const priceInput = row.querySelector('.price-input');
        const productId = select.value;
        if (productId && productPrices[productId]) {
            priceInput.value = productPrices[productId];
            console.log("Price updated to", productPrices[productId]);
        }
        calculateTotal();
    }

    function bindRowEvents(row) {
        const removeBtn = row.querySelector('.remove-item');
        if (removeBtn) {
            removeBtn.addEventListener('click', function () {
                removeRow(this);
            });
        }

        const productSelect = row.querySelector('.product-select');
        if (productSelect) {
            productSelect.addEventListener('change', function () {
                onProductChange(this);
            });
        }

        const quantityInput = row.querySelector('.quantity-input');
        if (quantityInput) {
            quantityInput.addEventListener('input', calculateTotal);
        }

        const priceInput = row.querySelector('.price-input');
        if (priceInput) {
            priceInput.addEventListener('input', calculateTotal);
        }
    }

    document.querySelectorAll('.item-row').forEach(bindRowEvents);
    calculateTotal();
});
</script>
{% endblock %}

{% block extra_css %}
<style>
    /* Приховати стандартний чекбокс видалення Django */
    input[name$="-DELETE"] {
        display: none;
    }

    /* Однаковий розмір заголовків карток */
    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        min-height: 55px;
        /* Фіксована мінімальна висота */
    }

    .card-title {
        margin-bottom: 0;
    }
</style>
{% endblock %}