{% extends 'base.html' %}
{% load humanize %}

{% block title %}Замовлення #{{ order.pk }} - CRMStore{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center mb-4">
    <div class="d-flex align-items-center gap-3">
        <a href="{% url 'order_list' %}" class="btn btn-outline btn-icon">
            <i class="bi bi-arrow-left"></i>
        </a>
        <div>
            <h1 class="page-title">Замовлення #{{ order.pk }}</h1>
            <p class="page-subtitle mb-0">Створено {{ order.created_at|date:"d.m.Y о H:i" }}</p>
        </div>
    </div>
    <div class="d-flex gap-2">
        <a href="{% url 'order_update' order.pk %}" class="btn btn-secondary">
            <i class="bi bi-pencil"></i>
            Редагувати
        </a>
        <button class="btn btn-outline" onclick="window.print()">
            <i class="bi bi-printer"></i>
            Друк
        </button>
    </div>
</div>

<div class="row g-4">
    <!-- Main Info -->
    <div class="col-lg-8">
        <!-- Status Card -->
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="card-title">Статус замовлення</h3>
                <span class="badge badge-{{ order.status }}" style="font-size: 14px; padding: 8px 16px;">
                    {{ order.get_status_display }}
                </span>
            </div>
            <div class="card-body">
                <form method="POST" class="row g-3 align-items-end">
                    {% csrf_token %}
                    <div class="col-md-5">
                        <label class="form-label">Змінити статус</label>
                        {{ status_form.status }}
                    </div>
                    <div class="col-md-5">
                        <label class="form-label">ТТН</label>
                        {{ status_form.ttn }}
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-check-lg"></i>
                            Зберегти
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Products -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="bi bi-box me-2"></i>
                    Товари
                </h3>
            </div>
            <div class="card-body p-0">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Товар</th>
                            <th>Артикул</th>
                            <th>Ціна</th>
                            <th>Кількість</th>
                            <th>Сума</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in order.items.all %}
                        <tr>
                            <td>
                                <div class="product-row">
                                    <span class="product-color"
                                        style="background: {% cycle '#6366f1' '#10b981' '#f59e0b' '#ef4444' '#8b5cf6' %}"></span>
                                    <span class="product-name">{{ item.product.name }}</span>
                                </div>
                            </td>
                            <td>{{ item.product.sku }}</td>
                            <td>{{ item.price|floatformat:2 }} ₴</td>
                            <td>{{ item.quantity }} шт</td>
                            <td><strong>{{ item.get_cost|floatformat:2 }} ₴</strong></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Customer Info -->
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="bi bi-person me-2"></i>
                    Клієнт
                </h3>
            </div>
            <div class="card-body">
                <div class="d-flex align-items-center gap-3 mb-3">
                    <div class="user-avatar" style="width: 48px; height: 48px;">
                        {{ order.customer.full_name|slice:":1"|upper }}
                    </div>
                    <div>
                        <div class="fw-bold">{{ order.customer.full_name }}</div>
                        <div class="text-muted">{{ order.customer.get_source_display }}</div>
                    </div>
                </div>
                <div class="mb-2">
                    <i class="bi bi-telephone me-2 text-muted"></i>
                    <a href="tel:{{ order.customer.phone }}" class="text-decoration-none">
                        {{ order.customer.phone }}
                    </a>
                </div>
                {% if order.customer.email %}
                <div>
                    <i class="bi bi-envelope me-2 text-muted"></i>
                    <a href="mailto:{{ order.customer.email }}" class="text-decoration-none">
                        {{ order.customer.email }}
                    </a>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Delivery Info -->
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="bi bi-truck me-2"></i>
                    Доставка
                </h3>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="text-muted small mb-1">Служба доставки</div>
                    <div class="fw-medium">{{ order.get_delivery_service_display }}</div>
                </div>
                <div class="mb-3">
                    <div class="text-muted small mb-1">Місто</div>
                    <div class="fw-medium">{{ order.city }}</div>
                </div>
                {% if order.warehouse %}
                <div class="mb-3">
                    <div class="text-muted small mb-1">Відділення</div>
                    <div class="fw-medium">{{ order.warehouse }}</div>
                </div>
                {% endif %}
                {% if order.ttn %}
                <div class="mb-3">
                    <div class="text-muted small mb-1">ТТН</div>
                    <div class="fw-medium">
                        <span class="badge badge-confirmed">{{ order.ttn }}</span>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Financial Summary -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="bi bi-calculator me-2"></i>
                    Фінанси
                </h3>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Тип оплати</span>
                    <span class="fw-medium">{{ order.get_payment_type_display }}</span>
                </div>
                <hr>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Сума товарів</span>
                    <span>{{ order.get_total_cost|floatformat:2 }} ₴</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Передплата</span>
                    <span class="text-success">-{{ order.prepayment|floatformat:2 }} ₴</span>
                </div>
                {% if order.seller_expenses > 0 %}
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Витрати продавця</span>
                    <span class="text-danger">{{ order.seller_expenses|floatformat:2 }} ₴</span>
                </div>
                {% endif %}
                <hr>
                <div class="d-flex justify-content-between mb-2">
                    <span class="fw-bold">До сплати (накл. платіж)</span>
                    <span class="fw-bold fs-5">{{ order.get_amount_due|floatformat:2 }} ₴</span>
                </div>
                <div class="d-flex justify-content-between">
                    <span class="text-muted">Прибуток</span>
                    <span class="text-success fw-medium">{{ order.get_profit|floatformat:2 }} ₴</span>
                </div>
            </div>
        </div>
    </div>
</div>

{% if order.notes %}
<!-- Notes -->
<div class="card mt-4">
    <div class="card-header">
        <h3 class="card-title">
            <i class="bi bi-sticky me-2"></i>
            Примітки
        </h3>
    </div>
    <div class="card-body">
        {{ order.notes }}
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_css %}
<style>
    @media print {

        .sidebar,
        .main-header,
        .btn,
        .filter-bar,
        form {
            display: none !important;
        }

        .main-content {
            margin-left: 0 !important;
        }

        .card {
            break-inside: avoid;
        }
    }
</style>
{% endblock %}